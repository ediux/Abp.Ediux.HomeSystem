@using Ediux.HomeSystem.Models.DTOs.FCM
@model FCMSettingsDTO
<script type="module">

    // Import the functions you need from the SDKs you need
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/@(Model.FCMVersion)/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/@(Model.FCMVersion)/firebase-analytics.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/@(Model.FCMVersion)/firebase-messaging.js';

    const firebaseConfig = {
      apiKey: "@(Model.apiKey)",
      authDomain: "@(Model.authDomain)",
      projectId: "@(Model.projectId)",
      storageBucket: "@(Model.storageBucket)",
      messagingSenderId: "@(Model.messagingSenderId)",
      appId: "@(Model.appId)",
      measurementId: "@(Model.measurementId)"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    const messaging = getMessaging(app);

    getToken(messaging, { vapidKey: '@(Model.vapidKey)' }).then((currentToken) => {
        if (currentToken) {
            // 成功取得 token
            ediux.homeSystem.notification.notification.registerUserToken(currentToken)
              .then(result=>{   
                 // 接收到通知時
                 onMessage(messaging, (payload) => {
                    console.log('Message received. ', payload);
                    //var notifyMsg = payload.notification;
                    //var notification = new Notification(notifyMsg.title, {
                    //    body: notifyMsg.body,
                    //    icon: notifyMsg.icon
                    //});

                    //notification.onclick = function (e) { // 綁定點擊事件
                    //    e.preventDefault(); // prevent the browser from focusing the Notification's tab

                    //    if(typeof(payload.data.link)!=='undefined'){
                    //        window.open(payload.data.link);
                    //    }            
                    //};
                });                
              }).catch(err=>{
                  abp.message.error('註冊失敗請檢查相關設定.'+err);
              });
        } else {
          // Show permission request UI
          abp.message.error('No registration token available. Request permission to generate one.');
        }
      }).catch((err) => {
        console.log('An error occurred while retrieving token. ', err);
        abp.message.error('An error occurred while retrieving token. '+err);
      });


</script>